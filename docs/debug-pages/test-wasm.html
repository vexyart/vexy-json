<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>vexy_json WASM Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      .test {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f5f5f5;
      }
      .success {
        border-color: #4caf50;
        background-color: #e8f5e9;
      }
      .error {
        border-color: #f44336;
        background-color: #ffebee;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      code {
        background-color: #f0f0f0;
        padding: 2px 4px;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>vexy_json WebAssembly Test Page</h1>
    <p>Testing the vexy_json WASM module functionality...</p>

    <div id="results"></div>

    <script type="module">
      import init, {
        parse_json,
        parse_json_with_options,
        validate_json,
        get_parser_options,
        stringify_value,
        get_version_info,
      } from '../pkg/vexy_json_wasm.js';

      const resultsDiv = document.getElementById('results');

      function addResult(title, success, details) {
        const div = document.createElement('div');
        div.className = `test ${success ? 'success' : 'error'}`;
        div.innerHTML = `
                <h3>${title}</h3>
                <pre>${details}</pre>
            `;
        resultsDiv.appendChild(div);
      }

      async function runTests() {
        try {
          // Initialize the WASM module
          await init();
          addResult(
            'WASM Module Initialization',
            true,
            'âœ… Module loaded successfully'
          );

          // Test 1: Get version info
          try {
            const versionInfo = get_version_info();
            addResult(
              'Version Info',
              true,
              `vexy_json v${versionInfo.version}\n${versionInfo.description}`
            );
          } catch (e) {
            addResult('Version Info', false, `Error: ${e.message}`);
          }

          // Test 2: Basic JSON parsing
          try {
            const result = parse_json('{"key": "value"}');
            addResult(
              'Basic JSON Parsing',
              true,
              `Input: {"key": "value"}\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult('Basic JSON Parsing', false, `Error: ${e.message}`);
          }

          // Test 3: Forgiving JSON with unquoted keys
          try {
            const result = parse_json('{key: "value"}');
            addResult(
              'Unquoted Keys',
              true,
              `Input: {key: "value"}\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult('Unquoted Keys', false, `Error: ${e.message}`);
          }

          // Test 4: Comments
          try {
            const result = parse_json(`{
                        // This is a comment
                        "key": "value" /* block comment */
                    }`);
            addResult(
              'JSON with Comments',
              true,
              `Input: JSON with comments\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult('JSON with Comments', false, `Error: ${e.message}`);
          }

          // Test 5: Single quotes
          try {
            const result = parse_json("{'key': 'value'}");
            addResult(
              'Single Quoted Strings',
              true,
              `Input: {'key': 'value'}\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult('Single Quoted Strings', false, `Error: ${e.message}`);
          }

          // Test 6: Trailing comma
          try {
            const result = parse_json('{"a": 1, "b": 2,}');
            addResult(
              'Trailing Comma',
              true,
              `Input: {"a": 1, "b": 2,}\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult('Trailing Comma', false, `Error: ${e.message}`);
          }

          // Test 7: Implicit array
          try {
            const result = parse_json('"a", "b", "c"');
            addResult(
              'Implicit Array',
              true,
              `Input: "a", "b", "c"\nOutput: ${JSON.stringify(result, null, 2)}`
            );
          } catch (e) {
            addResult('Implicit Array', false, `Error: ${e.message}`);
          }

          // Test 8: Implicit object
          try {
            const result = parse_json('key: "value", another: 123');
            addResult(
              'Implicit Object',
              true,
              `Input: key: "value", another: 123\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult('Implicit Object', false, `Error: ${e.message}`);
          }

          // Test 9: Validation
          try {
            const valid1 = validate_json('{"valid": true}');
            const valid2 = validate_json('{invalid');
            addResult(
              'JSON Validation',
              true,
              `Valid JSON: ${valid1}\nInvalid JSON: ${valid2}`
            );
          } catch (e) {
            addResult('JSON Validation', false, `Error: ${e.message}`);
          }

          // Test 10: Parser options
          try {
            const options = get_parser_options();
            addResult(
              'Parser Options',
              true,
              `Default options:\n${JSON.stringify(options, null, 2)}`
            );
          } catch (e) {
            addResult('Parser Options', false, `Error: ${e.message}`);
          }

          // Test 11: Parse with custom options (strict mode)
          try {
            const strictOptions = {
              allow_comments: false,
              allow_trailing_commas: false,
              allow_unquoted_keys: false,
              allow_single_quotes: false,
            };
            const result = parse_json_with_options(
              '{"key": "value"}',
              strictOptions.allow_comments,
              strictOptions.allow_trailing_commas,
              strictOptions.allow_unquoted_keys,
              strictOptions.allow_single_quotes,
              false, // implicit_top_level
              false, // newline_as_comma
              false, // enable_repair
              128 // max_depth
            );
            addResult(
              'Parse with Strict Options',
              true,
              `Strict mode parsing successful\nOutput: ${JSON.stringify(
                result,
                null,
                2
              )}`
            );
          } catch (e) {
            addResult(
              'Parse with Strict Options',
              false,
              `Error: ${e.message}`
            );
          }

          // Test 12: Error handling
          try {
            parse_json('{invalid json');
            addResult('Error Handling', false, 'Should have thrown an error');
          } catch (e) {
            addResult(
              'Error Handling',
              true,
              `Caught error: ${e.message}\nPosition: ${e.position || 'N/A'}`
            );
          }

          // Test 13: Stringify value
          try {
            const parsed = parse_json('{key: "value", num: 42}');
            const stringified = stringify_value(parsed);
            addResult(
              'Stringify Value',
              true,
              `Parsed then stringified:\n${stringified}`
            );
          } catch (e) {
            addResult('Stringify Value', false, `Error: ${e.message}`);
          }
        } catch (e) {
          addResult(
            'WASM Module Initialization',
            false,
            `Failed to load: ${e.message}`
          );
        }
      }

      // Run tests when page loads
      runTests();
    </script>
  </body>
</html>
